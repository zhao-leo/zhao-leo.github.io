<!DOCTYPE html>
<html lang="zh"><head>
<title>Yolo Binding的相关代码部分</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=5" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="yolo-binding的代码说明">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:url" content="https://www.zhaocloud.work/posts/yolo-binding%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E9%83%A8%E5%88%86/">
  <meta property="og:site_name" content="April Diary">
  <meta property="og:title" content="Yolo Binding的相关代码部分">
  <meta property="og:description" content="yolo-binding的代码说明">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-02-07T00:11:40+08:00">
    <meta property="article:modified_time" content="2025-02-07T00:11:40+08:00">
    <meta property="article:tag" content="Rust">












<script type="text/javascript">
  (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "pz9g1z5otp");
</script>



  




<link rel="icon" href="https://www.zhaocloud.work/favicon.ico">



      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css" integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>















<script>console.log("Hello from 'layouts/partials/extended_head.html'")</script>
<link rel='stylesheet' href='https://www.zhaocloud.work/fonts/result.css' />
<style>
  body {
    font-family: 'SDK_SC_Web', sans-serif;
  }
  code {
    font-family: 'SDK_SC_Web', sans-serif;
  }
</style>

</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    时间线
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    归档
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    标签
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/friends">
                    友链
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%96%87%e4%bb%b6%e7%bb%84%e7%bb%87" class="nav-文件组织">
									文件组织
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bb%a3%e7%a0%81%e7%9b%b8%e5%85%b3" class="nav-代码相关">
									代码相关
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%a2%84%e5%a4%84%e7%90%86" class="nav-预处理">
									预处理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%a8%a1%e5%9e%8b%e5%bc%95%e5%85%a5%e6%8e%a8%e7%90%86" class="nav-模型引入推理">
									模型引入&amp;推理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%90%8e%e5%a4%84%e7%90%86-%e4%b9%8b-core" class="nav-后处理-之-core">
									后处理 之 core
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%90%8e%e5%a4%84%e7%90%86-%e4%b9%8b-utils" class="nav-后处理-之-utils">
									后处理 之 utils
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://www.zhaocloud.work/">
            April Diary
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://www.zhaocloud.work/">
        <div class="single-column-header-title">April Diary</div>
        
        <div class="single-column-header-subtitle">人间四月芳菲尽</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    Yolo Binding的相关代码部分
                    
                    <div class="post-subtitle">
                        yolo-binding的代码说明
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2025-02-07 00:11
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/%E7%BC%96%E7%A8%8B">编程</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/rust">Rust</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="文件组织">文件组织</h2>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>YOLO_BINDING
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">│</span>  <span style="color:#ff6ac1">.</span>gitignore
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">│</span>  Cargo<span style="color:#ff6ac1">.</span>lock
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">│</span>  Cargo<span style="color:#ff6ac1">.</span>toml
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">│</span>  LICENSE
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">│</span>  readme<span style="color:#ff6ac1">.</span>md
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">│</span>
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">└─</span>src
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">│</span>  lib<span style="color:#ff6ac1">.</span>rs
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">├─</span>core
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">│</span>      <span style="color:#ff6ac1">export</span><span style="color:#ff6ac1">.</span>rs
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">│</span>      <span style="color:#ff5c57">load</span><span style="color:#ff6ac1">.</span>rs
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">│</span>      mod<span style="color:#ff6ac1">.</span>rs
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">│</span>      predict<span style="color:#ff6ac1">.</span>rs
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">│</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">└─</span>utils
</span></span><span style="display:flex;"><span>            HarmonyOS_Sans_Regular<span style="color:#ff6ac1">.</span>ttf
</span></span><span style="display:flex;"><span>            mod<span style="color:#ff6ac1">.</span>rs
</span></span><span style="display:flex;"><span>            picture<span style="color:#ff6ac1">.</span>rs
</span></span></code></pre></td></tr></table>
</div>
</div><p>一个好的项目要从文件开始设计(虽然咱是蒟蒻，也要有成为牛犇的理想哇！)</p>
<ul>
<li><code>core</code>是主推理环节，同时实现了预处理，推理，后处理三部分，是核心部分</li>
<li><code>utils</code>是对解析出的数据进行下一步解析，比如画框，打标签等，后续也是可以拓展的</li>
</ul>
<h2 id="代码相关">代码相关</h2>
<blockquote>
<p>这里不会展示所有代码，完整代码可以去仓库查看</p>
</blockquote>
<h3 id="预处理">预处理</h3>
<p>在这个环节，我使用了<code>tch</code>库中封装好的函数。</p>
<p>但这个环节会对原图像进行拉伸,归一化，建议输入正方形图片</p>
<blockquote>
<p>本来写了蒙灰色底版，但是<code>DynamicImage</code>转<code>Tensor</code>没有解决，后续再说吧</p>
</blockquote>
<p>整体代码类似，这里只展示一个：</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff6ac1">pub</span> <span style="color:#ff6ac1">fn</span> <span style="color:#57c7ff">load_one_image</span>(image_path: <span style="color:#ff6ac1">&amp;</span><span style="color:#9aedfe">str</span>) -&gt; <span style="color:#ff5c57">Result</span><span style="color:#ff6ac1">&lt;</span>Tensor, <span style="color:#ff5c57">Box</span><span style="color:#ff6ac1">&lt;</span><span style="color:#ff6ac1">dyn</span> Error<span style="color:#ff6ac1">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">let</span> image_tensor <span style="color:#ff6ac1">=</span> vision::image::load(Path::new(<span style="color:#ff6ac1">&amp;</span>image_path))<span style="color:#ff6ac1">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">let</span> image <span style="color:#ff6ac1">=</span> tch::vision::image::resize(<span style="color:#ff6ac1">&amp;</span>image_tensor, <span style="color:#ff9f43">640</span>, <span style="color:#ff9f43">640</span>)
</span></span><span style="display:flex;"><span>        .unwrap()
</span></span><span style="display:flex;"><span>        .unsqueeze(<span style="color:#ff9f43">0</span>)
</span></span><span style="display:flex;"><span>        .to_kind(tch::Kind::Float)
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">255.</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">Ok</span>(image)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>YOLO的输入张量形状:<code>[X,3,640,640]</code>，其中<code>X</code>是图片数量</p>
<h3 id="模型引入推理">模型引入&amp;推理</h3>
<p>由于<code>libtorch</code>的封装相当好，我们直接调用<code>torchscript</code>模型就可以</p>
<p>但是注意之前<code>torch_cuda.dll</code>的坑。</p>
<p>因为是自用的原因，我们直接调用在编写的时候，为了尽可能避免报错，允许在用户设置为<code>Gpu</code>时仍然调用<code>Cpu</code>，这点后续会删除，避免误导。</p>
<p><strong>模型加载</strong></p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff5c57">let</span> device <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">if</span> cuda <span style="color:#ff6ac1">==</span> <span style="color:#ff6ac1">true</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">let</span> <span style="color:#ff6ac1">mut</span> libtorch_path <span style="color:#ff6ac1">=</span> env::var(<span style="color:#5af78e">&#34;LIBTORCH&#34;</span>).unwrap();
</span></span><span style="display:flex;"><span>    libtorch_path.push_str(<span style="color:#5af78e">r</span><span style="color:#5af78e">&#34;\lib\torch_cuda.dll&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> Path::new(<span style="color:#ff6ac1">&amp;</span>libtorch_path).exists() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">let</span> path <span style="color:#ff6ac1">=</span> CString::from_str(<span style="color:#ff6ac1">&amp;</span>libtorch_path).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">unsafe</span> {
</span></span><span style="display:flex;"><span>            LoadLibraryA(path.as_ptr() <span style="color:#ff6ac1">as</span> <span style="color:#ff6ac1">*</span><span style="color:#ff6ac1">const</span> c_char);            }
</span></span><span style="display:flex;"><span>            Device::cuda_if_available()
</span></span><span style="display:flex;"><span>    } <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>        panic!(
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#34;No </span><span style="color:#5af78e">{}</span><span style="color:#5af78e"> exist,please check your libtorch version or set &#39;cuda&#39; false instead&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">&amp;</span>libtorch_path
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>    Device::Cpu
</span></span><span style="display:flex;"><span>}; <span style="color:#78787e">// device choiced
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff5c57">let</span> model <span style="color:#ff6ac1">=</span> CModule::load_on_device(Path::new(model_path), device).expect(<span style="color:#5af78e">&#34;load model failed&#34;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>YOLO导出的<code>torchscript</code>模型中是有元信息的，但是我没有在<code>torch-rs</code>中找到有关接口，因此：</p>
<blockquote>
<p>二进制，启动！！！</p>
</blockquote>
<p>这部分代码比较多，我不在这里展示，不过大概阐述一下原理，
我看了两个导出的模型，元信息是包在开始的九个<code>0x5A</code>和结尾的<code>0x504B</code>中，因此我们可以直接读入，然后进行解析</p>
<blockquote>
<p>事实上，这个<code>torchscript</code>文件是一个<code>.zip</code>的文件，因此你可以用<code>zip</code>进行解压，但是通过字节读取，我们可以得到更快的速度。</p>
<p>只是我没有见识，因此在下一版，我会把后识别符修改成<code>0x504B</code></p>
<p>2025/02/06T23:12在刷B站时发现的</p>
</blockquote>
<p>模型推理反倒是最简单的了，因为接口一步到位，只要注意张量设备转移就好。</p>
<p><strong>模型推理</strong></p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff5c57">let</span> input <span style="color:#ff6ac1">=</span> input.to_device(device);
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">let</span> output <span style="color:#ff6ac1">=</span> model
</span></span><span style="display:flex;"><span>    .yolo_model
</span></span><span style="display:flex;"><span>    .forward_ts(<span style="color:#ff6ac1">&amp;</span>[input])
</span></span><span style="display:flex;"><span>    .expect(<span style="color:#5af78e">&#34;forward failed&#34;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="后处理-之-core">后处理 之 core</h3>
<p>这部分是将YOLO推理出的矩阵进行变换，得到一个格式化数据的过程。</p>
<p>这里的代码编写时，对<code>Tensor</code>切分的逻辑放在了<code>mod.rs</code>中，后续会进行修改。</p>
<p>YOLO本身的输出张量形状时这样的:<code>[X,Y,8400]</code>，其中<code>X</code>是图片数量，<code>Y</code>是<code>xywh</code>+分类类型</p>
<p>为了得到<del>好看的框</del>，我们在下面引入两个参量：<code>confidence</code>和<code>threshold</code></p>
<ul>
<li><code>confidence</code>控制物品可信度筛选</li>
<li><code>threshold</code>控制<code>NMS</code>筛选</li>
</ul>
<p>我们就有以下逻辑；</p>
<ol>
<li>通过<code>conf</code>筛去置信度低的框</li>
<li>通过<code>threshold</code>筛去重复的框</li>
</ol>
<p>偷懒(✿◡‿◡)，代码黏在下面了：</p>
<p><strong>置信度筛选</strong></p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff6ac1">fn</span> <span style="color:#57c7ff">filter_confidence</span>(
</span></span><span style="display:flex;"><span>    tensor: <span style="color:#ff6ac1">&amp;</span><span style="color:#f3f99d">Tensor</span>,
</span></span><span style="display:flex;"><span>    confidence: <span style="color:#9aedfe">f64</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#ff5c57">Vec</span><span style="color:#ff6ac1">&lt;</span>(<span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">f64</span>)<span style="color:#ff6ac1">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#78787e">//Tensor [84, 8400]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    <span style="color:#ff5c57">let</span> pred <span style="color:#ff6ac1">=</span> tensor.transpose(<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">0</span>); <span style="color:#78787e">//Tensor [8400, 84]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    <span style="color:#ff5c57">let</span> (npreds, pred_size) <span style="color:#ff6ac1">=</span> pred.size2().unwrap();
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">let</span> full_xywh <span style="color:#ff6ac1">=</span> pred.slice(<span style="color:#ff9f43">1</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">4</span>, <span style="color:#ff9f43">1</span>); <span style="color:#78787e">//Tensor [8400, 4]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    <span style="color:#ff5c57">let</span> <span style="color:#ff6ac1">mut</span> filtered_results <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">Vec</span>::new();
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> index <span style="color:#ff6ac1">in</span> <span style="color:#ff9f43">0</span><span style="color:#ff6ac1">..</span>npreds {
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// iterate all predictions
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff5c57">let</span> pred <span style="color:#ff6ac1">=</span> pred.get(index); <span style="color:#78787e">// Tensor [84]
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff5c57">let</span> max_conf_index <span style="color:#ff6ac1">=</span> pred
</span></span><span style="display:flex;"><span>            .narrow(<span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">4</span>, pred_size <span style="color:#ff6ac1">-</span> <span style="color:#ff9f43">4</span>)
</span></span><span style="display:flex;"><span>            .argmax(<span style="color:#ff9f43">0</span>, <span style="color:#ff6ac1">true</span>)
</span></span><span style="display:flex;"><span>            .double_value(<span style="color:#ff6ac1">&amp;</span>[<span style="color:#ff9f43">0</span>]) <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">i64</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">let</span> max_conf <span style="color:#ff6ac1">=</span> pred.double_value(<span style="color:#ff6ac1">&amp;</span>[max_conf_index <span style="color:#ff6ac1">+</span> <span style="color:#ff9f43">4</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> max_conf <span style="color:#ff6ac1">&gt;</span> confidence {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> class_index <span style="color:#ff6ac1">=</span> max_conf_index;
</span></span><span style="display:flex;"><span>            filtered_results.push((
</span></span><span style="display:flex;"><span>                full_xywh.double_value(<span style="color:#ff6ac1">&amp;</span>[index, <span style="color:#ff9f43">0</span>]).round() <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">i64</span>,
</span></span><span style="display:flex;"><span>                full_xywh.double_value(<span style="color:#ff6ac1">&amp;</span>[index, <span style="color:#ff9f43">1</span>]).round() <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">i64</span>,
</span></span><span style="display:flex;"><span>                full_xywh.double_value(<span style="color:#ff6ac1">&amp;</span>[index, <span style="color:#ff9f43">2</span>]).round() <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">i64</span>,
</span></span><span style="display:flex;"><span>                full_xywh.double_value(<span style="color:#ff6ac1">&amp;</span>[index, <span style="color:#ff9f43">3</span>]).round() <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">i64</span>,
</span></span><span style="display:flex;"><span>                class_index,
</span></span><span style="display:flex;"><span>                max_conf,
</span></span><span style="display:flex;"><span>            ));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    filtered_results
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NMS筛选</strong></p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff6ac1">fn</span> <span style="color:#57c7ff">nms</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">mut</span> boxes: <span style="color:#ff5c57">Vec</span><span style="color:#ff6ac1">&lt;</span>(<span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">f64</span>)<span style="color:#ff6ac1">&gt;</span>,
</span></span><span style="display:flex;"><span>    threshold: <span style="color:#9aedfe">f64</span>,
</span></span><span style="display:flex;"><span>) -&gt; <span style="color:#ff5c57">Vec</span><span style="color:#ff6ac1">&lt;</span>(<span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">f64</span>)<span style="color:#ff6ac1">&gt;</span> {
</span></span><span style="display:flex;"><span>    boxes.sort_unstable_by(<span style="color:#ff6ac1">|</span>a, b<span style="color:#ff6ac1">|</span> b.<span style="color:#ff9f43">5.</span>partial_cmp(<span style="color:#ff6ac1">&amp;</span>a.<span style="color:#ff9f43">5</span>).unwrap_or(std::cmp::Ordering::Equal));
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">let</span> <span style="color:#ff6ac1">mut</span> suppressed <span style="color:#ff6ac1">=</span> vec![<span style="color:#ff6ac1">false</span>; boxes.len()];
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">let</span> to_xyxy <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">|</span>x: <span style="color:#9aedfe">i64</span>, y: <span style="color:#9aedfe">i64</span>, w: <span style="color:#9aedfe">i64</span>, h: <span style="color:#9aedfe">i64</span><span style="color:#ff6ac1">|</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">let</span> (x, y, w, h) <span style="color:#ff6ac1">=</span> (x <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>, y <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>, w <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>, h <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">let</span> x1 <span style="color:#ff6ac1">=</span> x <span style="color:#ff6ac1">-</span> w <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">let</span> y1 <span style="color:#ff6ac1">=</span> y <span style="color:#ff6ac1">-</span> h <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">let</span> x2 <span style="color:#ff6ac1">=</span> x <span style="color:#ff6ac1">+</span> w <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">let</span> y2 <span style="color:#ff6ac1">=</span> y <span style="color:#ff6ac1">+</span> h <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.0</span>;
</span></span><span style="display:flex;"><span>        (x1, y1, x2, y2)
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">let</span> compute_iou <span style="color:#ff6ac1">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">|</span>a: <span style="color:#ff6ac1">&amp;</span>(<span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">f64</span>), b: <span style="color:#ff6ac1">&amp;</span>(<span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">i64</span>, <span style="color:#9aedfe">f64</span>)<span style="color:#ff6ac1">|</span> -&gt; <span style="color:#9aedfe">f64</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> a_rect <span style="color:#ff6ac1">=</span> to_xyxy(a.<span style="color:#ff9f43">0</span>, a.<span style="color:#ff9f43">1</span>, a.<span style="color:#ff9f43">2</span>, a.<span style="color:#ff9f43">3</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> b_rect <span style="color:#ff6ac1">=</span> to_xyxy(b.<span style="color:#ff9f43">0</span>, b.<span style="color:#ff9f43">1</span>, b.<span style="color:#ff9f43">2</span>, b.<span style="color:#ff9f43">3</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">// Calculate intersection area
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#ff5c57">let</span> inter_x1 <span style="color:#ff6ac1">=</span> a_rect.<span style="color:#ff9f43">0.</span>max(b_rect.<span style="color:#ff9f43">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> inter_y1 <span style="color:#ff6ac1">=</span> a_rect.<span style="color:#ff9f43">1.</span>max(b_rect.<span style="color:#ff9f43">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> inter_x2 <span style="color:#ff6ac1">=</span> a_rect.<span style="color:#ff9f43">2.</span>min(b_rect.<span style="color:#ff9f43">2</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> inter_y2 <span style="color:#ff6ac1">=</span> a_rect.<span style="color:#ff9f43">3.</span>min(b_rect.<span style="color:#ff9f43">3</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> inter_area <span style="color:#ff6ac1">=</span> (inter_x2 <span style="color:#ff6ac1">-</span> inter_x1).max(<span style="color:#ff9f43">0.0</span>) <span style="color:#ff6ac1">*</span> (inter_y2 <span style="color:#ff6ac1">-</span> inter_y1).max(<span style="color:#ff9f43">0.0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> a_area <span style="color:#ff6ac1">=</span> (a_rect.<span style="color:#ff9f43">2</span> <span style="color:#ff6ac1">-</span> a_rect.<span style="color:#ff9f43">0</span>) <span style="color:#ff6ac1">*</span> (a_rect.<span style="color:#ff9f43">3</span> <span style="color:#ff6ac1">-</span> a_rect.<span style="color:#ff9f43">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> b_area <span style="color:#ff6ac1">=</span> (b_rect.<span style="color:#ff9f43">2</span> <span style="color:#ff6ac1">-</span> b_rect.<span style="color:#ff9f43">0</span>) <span style="color:#ff6ac1">*</span> (b_rect.<span style="color:#ff9f43">3</span> <span style="color:#ff6ac1">-</span> b_rect.<span style="color:#ff9f43">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> union_area <span style="color:#ff6ac1">=</span> a_area <span style="color:#ff6ac1">+</span> b_area <span style="color:#ff6ac1">-</span> inter_area;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> union_area <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">0.0</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff9f43">0.0</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>                inter_area <span style="color:#ff6ac1">/</span> union_area
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">for</span> i <span style="color:#ff6ac1">in</span> <span style="color:#ff9f43">0</span><span style="color:#ff6ac1">..</span>boxes.len() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> suppressed[i] {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">for</span> j <span style="color:#ff6ac1">in</span> (i <span style="color:#ff6ac1">+</span> <span style="color:#ff9f43">1</span>)<span style="color:#ff6ac1">..</span>boxes.len() {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> suppressed[j] {
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">continue</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> boxes[i].<span style="color:#ff9f43">4</span> <span style="color:#ff6ac1">!=</span> boxes[j].<span style="color:#ff9f43">4</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">continue</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">let</span> iou <span style="color:#ff6ac1">=</span> compute_iou(<span style="color:#ff6ac1">&amp;</span>boxes[i], <span style="color:#ff6ac1">&amp;</span>boxes[j]);
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> iou <span style="color:#ff6ac1">&gt;</span> threshold {
</span></span><span style="display:flex;"><span>                suppressed[j] <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    boxes 
</span></span><span style="display:flex;"><span>        .into_iter()
</span></span><span style="display:flex;"><span>        .enumerate()
</span></span><span style="display:flex;"><span>        .filter(<span style="color:#ff6ac1">|</span>(i, _)<span style="color:#ff6ac1">|</span> <span style="color:#ff6ac1">!</span>suppressed[<span style="color:#ff6ac1">*</span>i])
</span></span><span style="display:flex;"><span>        .map(<span style="color:#ff6ac1">|</span>(_, b)<span style="color:#ff6ac1">|</span> b)
</span></span><span style="display:flex;"><span>        .collect()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>核心逻辑都是一些简单的循环，主要是协调各个API，使程序正常工作。</p>
<h3 id="后处理-之-utils">后处理 之 utils</h3>
<p>这部分主要实现画框的逻辑</p>
<p>主要依赖于Rust的<code>imageproc</code>库</p>
<p>首先是将<code>xywh</code>转成合适的<code>xyxy</code>形式的坐标</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff5c57">let</span> (x, y, w, h) <span style="color:#ff6ac1">=</span> (x <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>, y <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>, w <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>, h <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">let</span> (width, height) <span style="color:#ff6ac1">=</span> picture.dimensions();
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">let</span> (x1, y1, x2, y2) <span style="color:#ff6ac1">=</span> (
</span></span><span style="display:flex;"><span>    (x <span style="color:#ff6ac1">-</span> w <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.</span>) <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">640.</span> <span style="color:#ff6ac1">*</span> width <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>,
</span></span><span style="display:flex;"><span>    (y <span style="color:#ff6ac1">-</span> h <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.</span>) <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">640.</span> <span style="color:#ff6ac1">*</span> height <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>,
</span></span><span style="display:flex;"><span>    (x <span style="color:#ff6ac1">+</span> w <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.</span>) <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">640.</span> <span style="color:#ff6ac1">*</span> width <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>,
</span></span><span style="display:flex;"><span>    (y <span style="color:#ff6ac1">+</span> h <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">2.</span>) <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">640.</span> <span style="color:#ff6ac1">*</span> height <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f64</span>,
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">let</span> (x1, y1, x2, y2) <span style="color:#ff6ac1">=</span> (x1 <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f32</span>, y1 <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f32</span>, x2 <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f32</span>, y2 <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">f32</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后是画框</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>draw_line_segment_mut(<span style="color:#ff6ac1">&amp;</span><span style="color:#ff6ac1">mut</span> picture, (x1, y1), (x2, y1), Rgba([<span style="color:#ff9f43">255</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">255</span>]));
</span></span><span style="display:flex;"><span>draw_line_segment_mut(<span style="color:#ff6ac1">&amp;</span><span style="color:#ff6ac1">mut</span> picture, (x2, y1), (x2, y2), Rgba([<span style="color:#ff9f43">255</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">255</span>]));
</span></span><span style="display:flex;"><span>draw_line_segment_mut(<span style="color:#ff6ac1">&amp;</span><span style="color:#ff6ac1">mut</span> picture, (x2, y2), (x1, y2), Rgba([<span style="color:#ff9f43">255</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">255</span>]));
</span></span><span style="display:flex;"><span>draw_line_segment_mut(<span style="color:#ff6ac1">&amp;</span><span style="color:#ff6ac1">mut</span> picture, (x1, y2), (x1, y1), Rgba([<span style="color:#ff9f43">255</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">255</span>]));
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后是画字</p>
<div class="highlight"><div style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#ff5c57">let</span> scale <span style="color:#ff6ac1">=</span> ab_glyph::PxScale::from(<span style="color:#ff9f43">20.0</span>);
</span></span><span style="display:flex;"><span>draw_text_mut(
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&amp;</span><span style="color:#ff6ac1">mut</span> picture,
</span></span><span style="display:flex;"><span>    Rgba([<span style="color:#ff9f43">255</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">0</span>, <span style="color:#ff9f43">255</span>]),
</span></span><span style="display:flex;"><span>    x1 <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">i32</span>,
</span></span><span style="display:flex;"><span>    y1 <span style="color:#ff6ac1">as</span> <span style="color:#9aedfe">i32</span>,
</span></span><span style="display:flex;"><span>    scale,
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&amp;</span>font,
</span></span><span style="display:flex;"><span>    type_name,
</span></span><span style="display:flex;"><span>        );
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，我们就用Rust实现了基本的<code>yolo-detection</code>封装。</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">最后修改于 2025-02-07</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/posts/cms%E6%96%87%E6%A1%A3%E4%B8%8A%E4%BC%A0/">
			下回<br>CMS文档上传
                </a>
                
                
                
                <a class="older-posts" href="/posts/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1yolo%E7%9A%84rust%E5%AE%9E%E7%8E%B0/">
			上回<br>记录一次YOLO的RUST实现
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












<script src="https://giscus.app/client.js"
        data-repo="zhao-leo/zhao-leo.github.io"
        data-repo-id="R_kgDOKAOfXw"
        data-category="General"
        data-category-id="DIC_kwDOKAOfX84CmVot"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://www.zhaocloud.work/">
    
        <div class="nav-title">
            April Diary
        </div>
        
        <div class="nav-subtitle">
            人间四月芳菲尽
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                时间线
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                归档
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                标签
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/friends">
                友链
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	April. 本站遵循 CC-BY-NC 4.0 协议
	
<br>
<a href="https://icp.gov.moe/?keyword=20250610" target="_blank">萌ICP备20250610号</a>

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%96%87%e4%bb%b6%e7%bb%84%e7%bb%87" class="nav-文件组织">
									文件组织
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bb%a3%e7%a0%81%e7%9b%b8%e5%85%b3" class="nav-代码相关">
									代码相关
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%a2%84%e5%a4%84%e7%90%86" class="nav-预处理">
									预处理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%a8%a1%e5%9e%8b%e5%bc%95%e5%85%a5%e6%8e%a8%e7%90%86" class="nav-模型引入推理">
									模型引入&amp;推理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%90%8e%e5%a4%84%e7%90%86-%e4%b9%8b-core" class="nav-后处理-之-core">
									后处理 之 core
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%90%8e%e5%a4%84%e7%90%86-%e4%b9%8b-utils" class="nav-后处理-之-utils">
									后处理 之 utils
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	April. 本站遵循 CC-BY-NC 4.0 协议
	
<br>
<a href="https://icp.gov.moe/?keyword=20250610" target="_blank">萌ICP备20250610号</a>
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
